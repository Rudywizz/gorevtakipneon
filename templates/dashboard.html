{% extends 'base.html' %}
{% from '_macros.html' import status_badge %}

{% block title %}Görev Paneli{% endblock %}

{# Stil: satır kısaltma + mini avatar #}
{% block extra_head %}
<style>
  .truncate-1 { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .truncate-2 {
    display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2;
    overflow: hidden;
  }
  .avatar {
    width: 28px; height: 28px; border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: .8rem; font-weight: 600; background: #e9ecef; color: #495057;
  }
  body.dark-mode .avatar { background: #2a2a2a; color: #f1f1f1; }
  .table thead th { font-weight: 600; }
</style>
{% endblock %}

{# Üst şerit: sayaç kartları #}
{% block pre_content %}
  {% include "partials/_stats.html" %}
{% endblock %}

{# Başlık + minimalist filtre barı #}
{% block page_header %}
<form class="w-100" method="get" action="{{ url_for('dashboard') }}" id="filterForm" role="search" aria-label="Görev filtreleri">
  <div class="d-flex flex-column gap-1">
    <div class="input-group">
      <span class="input-group-text" id="q-label"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" name="q" aria-labelledby="q-label"
             placeholder="Ara (görev adı, yer, malzeme)" value="{{ q }}">
      <button class="btn btn-primary btn-elevate ripple-wrap" type="submit">
        <i class="bi bi-funnel me-1"></i> Uygula
      </button>
      <a class="btn btn-outline-secondary btn-elevate ripple-wrap" href="{{ url_for('dashboard') }}">
        <i class="bi bi-arrow-counterclockwise me-1"></i> Sıfırla
      </a>
      <button class="btn btn-outline-dark btn-elevate ripple-wrap" type="button"
              data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="bi bi-sliders"></i> Filtreler
      </button>
    </div>
    <div class="text-muted small">Toplam sonuç: {{ total }}</div>
  </div>

  {# Modal: Detaylı filtreler #}
  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-elevate">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Detaylı Filtreler</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label for="status" class="form-label">Durum</label>
              <select class="form-select" id="status" name="status">
                <option value="" {{ '' == f_status and 'selected' or '' }}>Tümü</option>
                <option value="Planlandi"   {{ 'Planlandi'   == f_status and 'selected' or '' }}>Planlandı</option>
                <option value="DevamEdiyor" {{ 'DevamEdiyor' == f_status and 'selected' or '' }}>Devam Ediyor</option>
                <option value="Tamamlandi"  {{ 'Tamamlandi'  == f_status and 'selected' or '' }}>Tamamlandı</option>
              </select>
            </div>

            <div class="col-12">
              <label for="assigned" class="form-label">Atanan</label>
              <select class="form-select" id="assigned" name="assigned">
                <option value="" {{ (f_assigned == '' or f_assigned is none) and 'selected' or '' }}>Herkes</option>
                {% for u in all_users %}
                  <option value="{{ u.id }}" {{ (f_assigned|string) == (u.id|string) and 'selected' or '' }}>
                    {{ u.username }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="mine" name="mine"
                       {{ mine and 'checked' or '' }}>
                <label class="form-check-label" for="mine">
                  Sadece benim görevlerim
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <a class="btn btn-outline-secondary ripple-wrap" href="{{ url_for('dashboard') }}">
            <i class="bi bi-x-circle"></i> Temizle
          </a>
          <div>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Kapat</button>
            <button type="submit" class="btn btn-primary">Uygula</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block content %}
<div class="row g-3">
  <!-- Sol: Görev Ekleme -->
  <div class="col-md-6">
    <div class="card card-elevate shadow-sm">
      <div class="card-body">
        <h4 class="card-title mb-4 d-flex align-items-center gap-2">
          <i class="bi bi-plus-circle"></i> Yeni Görev Ekle
        </h4>

        <form method="POST" action="{{ url_for('dashboard') }}" novalidate>
          <div class="mb-3">
            <label for="title" class="form-label">Görev Adı</label>
            <input type="text" class="form-control" id="title" name="title" required>
          </div>

          <div class="mb-3">
            <label for="location" class="form-label">Görev Yeri</label>
            <input type="text" class="form-control" id="location" name="location">
          </div>

          <div class="mb-3">
            <label for="materials" class="form-label">Gerekli Malzemeler</label>
            <input type="text" class="form-control" id="materials" name="materials">
          </div>

          <div class="mb-3">
            <label for="date" class="form-label">Planlanan Tarih</label>
            <input type="date" class="form-control" id="date" name="date">
          </div>

          <div class="mb-3">
            <label for="needs_support" class="form-label">Destek Birimi (varsa)</label>
            <input type="text" class="form-control" id="needs_support" name="needs_support">
          </div>

          <div class="mb-3">
            <label for="assigned_to" class="form-label">Görevi Atayacağınız Kişi</label>
            <select class="form-select" id="assigned_to" name="assigned_to">
              <option value="">Kendinize Atayın</option>
              {% for u in all_users %}
                <option value="{{ u.id }}" {% if u.id == current_user %}selected{% endif %}>
                  {{ u.username }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="status_form" class="form-label">Durum</label>
            <select class="form-select" id="status_form" name="status" required>
              <option value="Planlandi" selected>Planlandı</option>
              <option value="DevamEdiyor">Devam Ediyor</option>
              <option value="Tamamlandi">Tamamlandı</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100 btn-elevate ripple-wrap">
            <i class="bi bi-save2 me-1"></i> Görevi Kaydet
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Sağ: Görev Listesi -->
  <div class="col-md-6">
    <div class="card card-elevate shadow-sm">
      <div class="card-body">
        <h4 class="card-title mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-list-task"></i> Görev Listesi
        </h4>

        {% if tasks %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-2">
            <thead class="table-light">
              <tr>
                <th><i class="bi bi-hash"></i> Ad</th>
                <th><i class="bi bi-geo-alt"></i> Yer</th>
                <th><i class="bi bi-calendar3"></i> Tarih</th>
                <th><i class="bi bi-activity"></i> Durum</th>
                <th><i class="bi bi-person"></i> Atanan</th>
                <th class="text-end" style="width:120px">İşlem</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tasks %}
              <tr>
                <td class="truncate-2" title="{{ t.title }}">{{ t.title }}</td>
                <td class="truncate-1" title="{{ t.location }}">{{ t.location }}</td>
                <td>{{ t.date|safe_date }}</td>
                <td>
                  {{ status_badge(t.status, t.accepted, t.completed) }}
                </td>
                <td>
                  {% set name = t.assignee_name or '-' %}
                  <span class="d-inline-flex align-items-center gap-2">
                    <span class="avatar">{{ name[:1]|upper }}</span>
                    <span class="truncate-1" title="{{ name }}">{{ name }}</span>
                  </span>
                </td>
                <td class="text-end">
                  {% if t.user_id == current_user %}
                    <form method="POST" action="{{ url_for('delete_task', task_id=t.id) }}"
                          onsubmit="return confirm('Bu görevi silmek istiyor musunuz?');" class="d-inline-block">
                      <button type="submit" class="btn btn-sm btn-danger btn-elevate ripple-wrap" data-bs-toggle="tooltip" title="Sil">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  {% else %}
                    <span class="text-muted small" data-bs-toggle="tooltip" title="Yalnızca görevi oluşturan kişi silebilir.">
                      Silme Yetkiniz Yok
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# Sayfalama #}
        <nav aria-label="Sayfalama" class="mt-2">
          <ul class="pagination pagination-sm justify-content-end mb-0">
            <li class="page-item {{ 1 == page and 'disabled' or '' }}">
              <a class="page-link"
                 href="{{ url_for('dashboard', page=page-1 if page>1 else 1, q=q, status=f_status, assigned=f_assigned, mine='1' if mine else None) }}">
                Önceki
              </a>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Sayfa {{ page }} / {{ pages }}</span>
            </li>
            <li class="page-item {{ page >= pages and 'disabled' or '' }}">
              <a class="page-link"
                 href="{{ url_for('dashboard', page=page+1 if page<pages else pages, q=q, status=f_status, assigned=f_assigned, mine='1' if mine else None) }}">
                Sonraki
              </a>
            </li>
          </ul>
        </nav>
        {% else %}
          <div class="alert alert-light border d-flex align-items-center gap-2 mb-0" role="alert">
            <i class="bi bi-inbox"></i>
            Henüz görev girilmemiş.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
