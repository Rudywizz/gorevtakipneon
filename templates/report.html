{% extends 'base.html' %}

{% block title %}Raporlama{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- KPI kartları -->
  <div class="col-12">
    <div class="row g-3">
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card bg-primary text-white shadow-sm border-0">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="fs-6 opacity-75">Toplam Görev</div>
              <div class="fs-3 fw-bold">{{ total_tasks or 0 }}</div>
            </div>
            <i class="bi bi-collection fs-1 opacity-75"></i>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card bg-warning text-dark shadow-sm border-0">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="fs-6">Devam Ediyor</div>
              <div class="fs-3 fw-bold">{{ ongoing_tasks or 0 }}</div>
            </div>
            <i class="bi bi-hourglass-split fs-1"></i>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card bg-success text-white shadow-sm border-0">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="fs-6 opacity-75">Tamamlandı</div>
              <div class="fs-3 fw-bold">{{ completed_tasks or 0 }}</div>
            </div>
            <i class="bi bi-check2-circle fs-1 opacity-75"></i>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card bg-secondary text-white shadow-sm border-0">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="fs-6 opacity-75">Planlandı</div>
              <div class="fs-3 fw-bold">{{ planned_tasks or 0 }}</div>
            </div>
            <i class="bi bi-calendar-event fs-1 opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtre & Export -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <form class="row g-2 align-items-end" method="get" action="{{ url_for('report') }}">
          <div class="col-12 col-md-3">
            <label class="form-label small text-muted">Ara</label>
            <input type="text" class="form-control" name="q" placeholder="ad, yer, malzeme"
                   value="{{ q or '' }}">
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label small text-muted">Durum</label>
            <select class="form-select" name="status">
              <option value="">(tümü)</option>
              <option value="Planlandi"   {% if f_status=='Planlandi' %}selected{% endif %}>Planlandı</option>
              <option value="DevamEdiyor" {% if f_status=='DevamEdiyor' %}selected{% endif %}>Devam Ediyor</option>
              <option value="Tamamlandi"  {% if f_status=='Tamamlandi' %}selected{% endif %}>Tamamlandı</option>
            </select>
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label small text-muted">Atanan</label>
            <select class="form-select" name="assigned">
              <option value="">(tümü)</option>
              {% for u in all_users %}
                <option value="{{ u.id }}" {% if f_assigned|int == u.id %}selected{% endif %}>{{ u.username }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label small text-muted">Başlangıç</label>
            <input type="date" class="form-control" name="from" value="{{ date_from or '' }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label small text-muted">Bitiş</label>
            <input type="date" class="form-control" name="to" value="{{ date_to or '' }}">
          </div>

          <div class="col-12 col-md-1">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="mine" name="mine" value="1" {% if mine %}checked{% endif %}>
              <label class="form-check-label small" for="mine">Benim</label>
            </div>
          </div>

          <div class="col-12 col-md-auto">
            <button class="btn btn-primary"><i class="bi bi-funnel me-1"></i>Filtrele</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('report') }}"><i class="bi bi-x-circle me-1"></i>Temizle</a>
          </div>

          <!-- Export butonları: mevcut filtrelerle querystring ekli -->
          <div class="col-12 col-md-auto ms-auto">
            <a class="btn btn-success"
               href="{{ url_for('export_excel') }}?q={{ (q or '')|urlencode }}&status={{ f_status or '' }}&assigned={{ f_assigned or '' }}&from={{ date_from or '' }}&to={{ date_to or '' }}{% if mine %}&mine=1{% endif %}">
              <i class="bi bi-file-earmark-excel me-1"></i>Excel
            </a>
            <a class="btn btn-danger"
               href="{{ url_for('export_pdf') }}?q={{ (q or '')|urlencode }}&status={{ f_status or '' }}&assigned={{ f_assigned or '' }}&from={{ date_from or '' }}&to={{ date_to or '' }}{% if mine %}&mine=1{% endif %}">
              <i class="bi bi-file-earmark-pdf me-1"></i>PDF
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Grafikler -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Durum Dağılımı</h5>
        <canvas id="statusChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Kullanıcıya Göre Tamamlananlar (Top 8)</h5>
        <canvas id="userChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <!-- Detay tablo -->
  <div class="col-12">
    <div class="card shadow">
      <div class="card-body">
        <h4 class="card-title mb-3">Detaylı Liste</h4>

        {% if tasks %}
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Görev</th>
                  <th>Yer</th>
                  <th>Tarih</th>
                  <th>Durum</th>
                  <th>Malzemeler</th>
                  <th>Destek Birimi</th>
                  <th>Atanan</th>
                  <th>Görevi Giren</th>
                  <th>Açıklama</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tasks %}
                  {% set s = (t.status or '') %}
                  {% set s_l = s|lower %}
                  {% if 'tamam' in s_l %}
                    {% set badge_cls = 'badge bg-success-subtle text-success-emphasis border border-success-subtle' %}
                    {% set badge_txt = 'Tamamlandı' %}
                  {% elif 'devam' in s_l %}
                    {% set badge_cls = 'badge bg-warning-subtle text-warning-emphasis border border-warning-subtle' %}
                    {% set badge_txt = 'Devam Ediyor' %}
                  {% else %}
                    {% set badge_cls = 'badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle' %}
                    {% set badge_txt = 'Planlandı' %}
                  {% endif %}
                <tr>
                  <td class="fw-medium">{{ t.title }}</td>
                  <td>{{ t.location or '—' }}</td>
                  <td>{{ t.date or '—' }}</td>
                  <td><span class="{{ badge_cls }}">{{ badge_txt }}</span></td>
                  <td class="small">{{ t.materials or '—' }}</td>
                  <td class="small">{{ t.needs_support or '—' }}</td>
                  <td>{{ t.assignee_name or '—' }}</td>
                  <td>{{ t.assigner_name or '—' }}</td>
                  <td class="small">{{ t.completion_note or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-light border d-flex align-items-center gap-2">
            <i class="bi bi-inbox fs-5"></i> Filtreye uyan görev bulunamadı.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js (sadece bu sayfada) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function () {
  const tasksData = [
    {% for t in tasks %}
      {status: "{{ (t.status or '')|e }}", assignee: "{{ (t.assignee_name or '')|e }}"},
    {% endfor %}
  ];

  const statusCounts = { Planlandi:0, DevamEdiyor:0, Tamamlandi:0 };
  tasksData.forEach(t => { if (statusCounts[t.status] !== undefined) statusCounts[t.status]++; });

  const completedByUser = {};
  tasksData.forEach(t => {
    if (t.status === 'Tamamlandi') {
      const k = t.assignee || '—';
      completedByUser[k] = (completedByUser[k] || 0) + 1;
    }
  });
  const userLabelsAll = Object.keys(completedByUser).sort((a,b) => completedByUser[b]-completedByUser[a]);
  const userLabels = userLabelsAll.slice(0, 8);
  const userValues = userLabels.map(u => completedByUser[u]);

  const isDark = document.body.classList.contains('dark-mode');
  const axisColor = isDark ? '#d1d5db' : '#374151';
  const gridColor = isDark ? 'rgba(255,255,255,.1)' : 'rgba(0,0,0,.06)';

  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: { labels: ['Planlandı','Devam Ediyor','Tamamlandı'],
      datasets: [{ data: [statusCounts.Planlandi, statusCounts.DevamEdiyor, statusCounts.Tamamlandi] }] },
    options: { plugins: { legend: { labels: { color: axisColor } } } }
  });

  new Chart(document.getElementById('userChart'), {
    type: 'bar',
    data: { labels: userLabels, datasets: [{ label: 'Tamamlanan', data: userValues }] },
    options: {
      scales: {
        x: { ticks: { color: axisColor }, grid: { color: gridColor } },
        y: { ticks: { color: axisColor }, grid: { color: gridColor }, beginAtZero: true, precision: 0 }
      },
      plugins: { legend: { display: false } }
    }
  });
})();
</script>
{% endblock %}
