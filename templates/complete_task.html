{% extends 'base.html' %}
{% from '_macros.html' import status_badge %}

{% block title %}Görevi Tamamla{% endblock %}

{% block page_header %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
  <div class="d-flex align-items-center gap-2">
    <a href="{{ url_for('assigned_tasks') }}" class="btn btn-outline-secondary btn-elevate">
      <i class="bi bi-arrow-left"></i>
    </a>
    <h5 class="mb-0 d-flex align-items-center gap-2">
      <i class="bi bi-check2-circle text-success"></i>
      Görevi Tamamla
    </h5>
  </div>
  <div class="text-muted small">
    {% if task is defined and task %}
      ID: <code>{{ task.id }}</code>
    {% else %}
      ID: <code>{{ task_id }}</code>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8 mx-auto">

    {# Görev özeti (sunucu tarafı bu sayfaya 'task' göndermiyorsa sadece ID görünür) #}
    <div class="card card-raise mb-3">
      <div class="card-body">
        {% set T = task if task is defined else None %}
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold">
              {{ (T.title if T else 'Görev') or 'Görev' }}
            </div>
            <div class="text-muted small">
              {% if T and T.location %}<i class="bi bi-geo-alt me-1"></i>{{ T.location }}{% endif %}
              {% if T and T.date %}<span class="ms-3"><i class="bi bi-calendar2 me-1"></i>{{ T.date }}</span>{% endif %}
            </div>
          </div>
          <div class="text-nowrap">
            {% if T and T.status %}{{ status_badge(T.status) }}{% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card card-raise">
      <div class="card-body">
        <h6 class="mb-3">Tamamlama Notu</h6>
        <form method="POST" id="completeForm">
          <div class="mb-3">
            <label for="note" class="form-label fw-semibold">Açıklama / Yapılan İş</label>
            <textarea
              name="note"
              id="note"
              rows="6"
              class="form-control"
              placeholder="Yapılan işlemleri, kullanılan malzemeleri ve önemli gözlemleri kısaca yazın…"
              required
              maxlength="4000"
            ></textarea>
            <div class="form-text d-flex justify-content-between">
              <span>İpucu: Tarih, kişi, yer isimleri ve varsa ekip/destek bilgisi ekleyin.</span>
              <span><span id="charLeft">4000</span> karakter kaldı</span>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success btn-elevate" id="submitBtn">
              <i class="bi bi-check2-square me-1"></i>Görevi Sonlandır
            </button>
            <a href="{{ url_for('assigned_tasks') }}" class="btn btn-outline-secondary btn-elevate">
              Vazgeç
            </a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    const ta = document.getElementById('note');
    const left = document.getElementById('charLeft');
    const form = document.getElementById('completeForm');
    const submitBtn = document.getElementById('submitBtn');

    function autosize(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight + 2) + 'px';
    }
    function updateCount() {
      if (!ta || !left) return;
      const max = parseInt(ta.getAttribute('maxlength') || '4000', 10);
      const remaining = Math.max(0, max - ta.value.length);
      left.textContent = remaining;
    }

    if (ta) {
      autosize(ta);
      updateCount();
      ta.addEventListener('input', function () { autosize(ta); updateCount(); });
    }

    if (form) {
      form.addEventListener('submit', function () {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Kaydediliyor…';
        }
      });
    }
  })();
</script>
{% endblock %}
